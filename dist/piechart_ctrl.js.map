{"version":3,"sources":["../src/piechart_ctrl.js"],"names":[],"mappings":"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","file":"piechart_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport TimeSeries from 'app/core/time_series';\nimport rendering from './rendering';\nimport legend from './legend';\n\nvar panelDefaults = {\n  pieType: 'pie',\n  legend: {\n    show: true, // disable/enable legend\n    values: false, // disable/enable legend values\n    min: false,\n    max: false,\n    current: false,\n    total: false,\n    avg: false\n  },\n  links: [],\n  datasource: null,\n  maxDataPoints: 3,\n  interval: null,\n  targets: [{}],\n  cacheTimeout: null,\n  nullText: null,\n  nullPointMode: 'connected',\n  legendType: 'rightSide',\n  aliasColors: {},\n  format: 'short'\n};\n\nexport class PieChartCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $rootScope) {\n    super($scope, $injector);\n    this.$rootScope = $rootScope;\n\n    _.defaults(this.panel, panelDefaults);\n    _.defaults(this.panel.legend, panelDefaults.legend);\n\n    this.events.on('render', this.onRender.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/grafana-piechart-panel/editor.html', 2);\n    this.unitFormats = kbn.getUnitFormats();\n  }\n\n  setUnitFormat(subItem) {\n    this.panel.format = subItem.value;\n    this.render();\n  }\n\n  onDataError() {\n    this.series = [];\n    this.render();\n  }\n\n  changeSeriesColor(series, color) {\n    series.color = color;\n    this.panel.aliasColors[series.alias] = series.color;\n    this.render();\n  }\n\n  onRender() {\n    this.data = this.parseSeries(this.series);\n  }\n\n  parseSeries(series) {\n    if (!series) {\n      return;\n    }\n\n    var data = [];\n    for (var i=0; i < this.series.length; i++) {\n      var alias = this.series[i].alias;\n      var color = this.panel.aliasColors[alias] || this.$rootScope.colors[i];\n      data.push({\n        label: alias,\n        data: this.series[i].stats.current,\n        color: color});\n    }\n\n    return data;\n  }\n\n  onDataReceived(dataList) {\n    this.series = dataList.map(this.seriesHandler.bind(this));\n    this.data = this.parseSeries(this.series);\n    this.render(this.data);\n\n  }\n\n  seriesHandler(seriesData) {\n    var series = new TimeSeries({\n      datapoints: seriesData.datapoints,\n      alias: seriesData.target\n    });\n\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n    return series;\n  }\n\n  getDecimalsForValue(value) {\n    if (_.isNumber(this.panel.decimals)) {\n      return { decimals: this.panel.decimals, scaledDecimals: null };\n    }\n\n    var delta = value / 2;\n    var dec = -Math.floor(Math.log(delta) / Math.LN10);\n\n    var magn = Math.pow(10, -dec);\n    var norm = delta / magn; // norm is between 1.0 and 10.0\n    var size;\n\n    if (norm < 1.5) {\n      size = 1;\n    } else if (norm < 3) {\n      size = 2;\n      // special case for 2.5, requires an extra decimal\n      if (norm > 2.25) {\n        size = 2.5;\n        ++dec;\n      }\n    } else if (norm < 7.5) {\n      size = 5;\n    } else {\n      size = 10;\n    }\n\n    size *= magn;\n\n    // reduce starting decimals if not needed\n    if (Math.floor(value) === value) { dec = 0; }\n\n    var result = {};\n    result.decimals = Math.max(0, dec);\n    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\n\n    return result;\n  }\n\n  setValues(data) {\n    data.flotpairs = [];\n\n    if (this.series && this.series.length > 0) {\n      var lastPoint = _.last(this.series[0].datapoints);\n      var lastValue = _.isArray(lastPoint) ? lastPoint[0] : null;\n\n      if (_.isString(lastValue)) {\n        data.value = 0;\n        data.valueFormated = lastValue;\n        data.valueRounded = 0;\n      } else {\n        data.value = this.series[0].stats[this.panel.valueName];\n        data.flotpairs = this.series[0].flotpairs;\n\n        var decimalInfo = this.getDecimalsForValue(data.value);\n        data.valueFormated = formatValue(data.value);\n        data.valueRounded = kbn.roundValue(data.value, decimalInfo.decimals);\n      }\n    }\n\n    if (data.value === null || data.value === void 0) {\n      data.valueFormated = \"no value\";\n    }\n  }\n\n  formatValue(value) {\n    var decimalInfo = this.getDecimalsForValue(value);\n    var formatFunc = kbn.valueFormats[this.panel.format];\n    if (formatFunc) {\n      return formatFunc(value, decimalInfo.decimals, decimalInfo.scaledDecimals);\n    }\n    return value;\n  }\n\n  removeValueMap(map) {\n    var index = _.indexOf(this.panel.valueMaps, map);\n    this.panel.valueMaps.splice(index, 1);\n    this.render();\n  }\n\n  addValueMap() {\n    this.panel.valueMaps.push({value: '', op: '=', text: '' });\n  }\n\n  legendValuesOptionChanged() {\n    var legend = this.panel.legend;\n    legend.values = legend.min || legend.max || legend.avg || legend.current || legend.total;\n    this.render();\n  }\n\n  link(scope, elem, attrs, ctrl) {\n    rendering(scope, elem, attrs, ctrl);\n  }\n}\n\nPieChartCtrl.templateUrl = 'module.html';\n"]}
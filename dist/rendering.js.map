{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","find","$tooltip","$","events","on","render","legendType","setTimeout","setElementHeight","height","row","_","isString","parseInt","replace","title","css","e","formatter","label","slice","slice_data","length","decimal","start","fontSize","color","legend","percentageDecimals","values","percentage","formatValue","percent","toFixed","noDataPoints","html","addPieChart","width","size","Math","min","plotCanvas","plotCss","top","margin","position","backgroundColor","options","show","series","pie","stroke","parseFloat","strokeWidth","highlight","opacity","combine","threshold","grid","hoverable","clickable","pieType","innerRadius","i","hiddenSeries","stack","plot","bind","event","pos","item","detach","body","formatted","place_tt","pageX","pageY","incrementRenderCounter","renderingCompleted"],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport 'jquery.flot';\nimport 'jquery.flot.pie';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel;\n  elem = elem.find('.piechart-panel');\n  var $tooltip = $('<div id=\"tooltip\">');\n\n  ctrl.events.on('render', function() {\n    render(false);\n    if(panel.legendType === 'Right side') {\n      setTimeout(function() { render(true); }, 50);\n    }\n  });\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= 5; // padding\n      height -= panel.title ? 24 : 9; // subtract panel title bar\n\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch(e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n  function formatter(label, slice) {\n\n    var slice_data = slice.data[0][slice.data[0].length - 1];\n    var decimal = 2;\n    var start = \"<div style='font-size:\" + ctrl.panel.fontSize + \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label + \"<br/>\";\n\n    if(ctrl.panel.legend.percentageDecimals) {\n      decimal = ctrl.panel.legend.percentageDecimals;\n    }\n\n    if (ctrl.panel.legend.values && ctrl.panel.legend.percentage) {\n      return start + ctrl.formatValue(slice_data) + \"<br/>\" + slice.percent.toFixed(decimal) +\"%</div>\";\n    } else if (ctrl.panel.legend.values) {\n      return start + ctrl.formatValue(slice_data) + \"</div>\";\n    } else if (ctrl.panel.legend.percentage) {\n      return start + slice.percent.toFixed(decimal) + \"%</div>\";\n    } else {\n      return start + '</div>';\n    }\n\n  }\n\n  function noDataPoints() {\n\n    var html = '<div class=\"datapoints-warning\"><span class=\"small\">No data points</span></div>';\n\n    elem.html(html);\n  }\n\n  function addPieChart() {\n    var width = elem.width();\n    var height = elem.height();\n\n    var size = Math.min(width, height);\n\n    var plotCanvas = $('<div></div>');\n    var plotCss = {\n      top: '10px',\n      margin: 'auto',\n      position: 'relative',\n      height: (size - 20) + 'px'\n    };\n\n    plotCanvas.css(plotCss);\n\n    var backgroundColor = $('body').css('background-color')\n\n    var options = {\n      legend: {\n        show: false\n      },\n      series: {\n        pie: {\n          show: true,\n          stroke: {\n            color: backgroundColor,\n            width: parseFloat(ctrl.panel.strokeWidth).toFixed(1)\n          },\n          label: {\n            show: ctrl.panel.legend.show && ctrl.panel.legendType === 'On graph',\n            formatter: formatter\n          },\n          highlight: {\n            opacity: 0.0\n          },\n\t\t      combine: {\n\t\t        threshold: ctrl.panel.combine.threshold,\n\t\t\t      label: ctrl.panel.combine.label\n\t\t      }\n        }\n      },\n      grid: {\n        hoverable: true,\n        clickable: false\n      }\n    };\n\n    if (panel.pieType === 'donut') {\n      options.series.pie.innerRadius = 0.5;\n    }\n\n    data = ctrl.data;\n\n    for (let i = 0; i < data.length; i++) {\n      let series = data[i];\n\n      // if hidden remove points and disable stack\n      if (ctrl.hiddenSeries[series.label]) {\n        series.data = {};\n        series.stack = false;\n      }\n    }\n\n    elem.html(plotCanvas);\n\n    $.plot(plotCanvas, ctrl.data, options);\n    plotCanvas.bind(\"plothover\", function (event, pos, item) {\n      if (!item) {\n        $tooltip.detach();\n        return;\n      }\n\n      var body;\n      var percent = parseFloat(item.series.percent).toFixed(2);\n      var formatted = ctrl.formatValue(item.series.data[0][1]);\n\n      body = '<div class=\"graph-tooltip-small\"><div class=\"graph-tooltip-time\">';\n      body += '<div class=\"graph-tooltip-value\">' + item.series.label + ': ' + formatted;\n      body += \" (\" + percent + \"%)\" + '</div>';\n      body += \"</div></div>\";\n\n      $tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\n    });\n  }\n\n  function render(incrementRenderCounter) {\n    if (!ctrl.data) { return; }\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n    if (setElementHeight()) {\n      if (0 == ctrl.data.length) {\n        noDataPoints();\n      } else {\n        addPieChart();\n      }\n    }\n    if (incrementRenderCounter) {\n      ctrl.renderingCompleted();\n    }\n  }\n}\n\n"]}